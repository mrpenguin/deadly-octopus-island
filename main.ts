namespace myTiles {
    //% blockIdentity=images._tile
    export const tile0 = img`
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
    `
    //% blockIdentity=images._tile
    export const tile2 = img`
        b b b b b b b b
        e e e b b b b b
        b b b b b b b b
        b b b b b e e e
        b b b b b b b b
        b b e e e e e b
        b b b b b b b b
        b e e b b b e b
    `
    //% blockIdentity=images._tile
    export const tile3 = img`
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile4 = img`
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
    `
    //% blockIdentity=images._tile
    export const tile5 = img`
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
    `
    //% blockIdentity=images._tile
    export const tile6 = img`
        7 5 5 5 5 5 5 7
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        7 5 5 5 5 5 5 7
    `
    //% blockIdentity=images._tile
    export const tile7 = img`
        b b b b b b b b
        e e e e e e e e
        d d d d d d d d
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile8 = img`
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        d d d d d d d d
        e e e e e e e e
        b b b b b b b b
    `
    //% blockIdentity=images._tile
    export const tile9 = img`
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d d d d d d
        b e e e e e e e
        b b b b b b b b
    `
    //% blockIdentity=images._tile
    export const tile10 = img`
        b b b b b b b b
        e e e e e e e b
        d d d d d d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
    `
    //% blockIdentity=images._tile
    export const tile11 = img`
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        d d d d d d e b
        e e e e e e e b
        b b b b b b b b
    `
    //% blockIdentity=images._tile
    export const tile12 = img`
        b b b b b b b b
        b e e e e e e e
        b e d d d d d d
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile13 = img`
        8 8 8 8 8 d e b
        8 8 8 8 8 d e e
        8 8 8 8 8 d d d
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile14 = img`
        b e d 8 8 8 8 8
        e e d 8 8 8 8 8
        d d d 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile15 = img`
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        d d d 8 8 8 8 8
        e e d 8 8 8 8 8
        b e d 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile16 = img`
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 d d d
        8 8 8 8 8 d e e
        8 8 8 8 8 d e b
    `
    //% blockIdentity=images._tile
    export const tile17 = img`
        b b b b b b b b
        b b 3 3 3 b b b
        b b 3 b b 3 b b
        b b 3 b b 3 b b
        b b 3 3 3 b b b
        b b 3 b b b b b
        b b 3 b b b b b
        b b b b b b b b
    `
    //% blockIdentity=images._tile
    export const tile18 = img`
        d b b b b b b d
        b d b b b b d b
        b b d b b d b b
        b b b d d b b b
        b b b d d b b b
        b b d b b d b b
        b d b b b b d b
        d b b b b b b d
    `
    //% blockIdentity=images._tile
    export const tile19 = img`
        b b b b b b b b
        b b 2 2 2 b b b
        b 2 b b b 2 b b
        b 2 b b b b b b
        b b 2 2 2 b b b
        b b b b b 2 b b
        b 2 b b b 2 b b
        b b 2 2 2 b b b
    `
    //% blockIdentity=images._tile
    export const tile20 = img`
        4 4 4 4 4 4 4 4
        4 4 4 4 4 4 4 4
        5 5 5 5 5 5 5 5
        4 4 4 4 4 4 4 4
        4 4 4 4 4 4 4 4
        5 5 5 5 5 5 5 5
        4 4 4 4 4 4 4 4
        4 4 4 4 4 4 4 4
    `
    //% blockIdentity=images._tile
    export const tile21 = img`
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
    `
}

class Point {
    x: number
    y: number
    tile: Image = null
    constructor(x: number = 0, y: number = 0) {
        this.x = x
        this.y = y
    }
}

class GridSpot{
    row: number
    column: number
    constructor(row: number = 0, column: number = 0){
        this.row = row
        this.column = column
    }
    equals(otherSpot:GridSpot):boolean{
        return otherSpot.row === this.row && otherSpot.column === this.column
    }
}

sprites.onOverlap(SpriteKind.Player, SpriteKind.Food, function (sprite, otherSprite) {
    info.setScore(info.score() + 1)
    otherSprite.destroy()
})

let playerPosition:Point = new Point(0,0)
let octopusPosition:Point = new Point(0,0)
let sharkPosition:Point = new Point(0,0)
let sharkSeekPath:Array<GridSpot> = []
const hitBuffer:number = 4
const tileSize:number = 8
let mySprite = sprites.create(img`
    . . . . . . . .
    . . . 1 1 . . .
    . . 1 1 1 1 . .
    3 4 1 1 1 1 4 3
    3 4 4 1 1 4 4 3
    . . 4 1 1 4 . .
    . . 1 1 1 1 . .
    . . . . . . . .
`, SpriteKind.Player)
let octopus = sprites.create(img`
    . d d d d . . . . . . . d d d d d d . . . . . . . . . d d d . .
    d d d . . . . . . . . d d d d d d d d d . . . . . d d d d d d .
    d d . . . . . . . . d d d d . . . . . d d . . . . d d . . . d d
    d d . . . . . . . . d d d . . . . . . . . . . . d d d . . . d d
    d d . d . . . . . . d d d . . . . . . . . . . d d d d . . . . d
    d d d . . . . . . . d d d d . . . . . . . . d d d d d . . . . .
    d d d d . . . . . . d d d 8 8 8 8 8 d d . . d d d d . . . . . .
    . d d d d . . . . . . 8 8 d d d d d d d d d d d d . . . . . . .
    . . d d d d d d d . 8 d d d d d d d d d d d d d d . . . . . . .
    . . . d d d d d d 8 d d d d d d d d d d d d d d . . . . . . . .
    . . . . . d d d d 8 d d d d d d d d d d d d d d . . . . . d d .
    . . . . . . d d 8 d d d d d d d d d d d d d d d d . d d d d d d
    . . . . . . . . 8 d d d d d d d d d d d d d d d d d d d d d d d
    . . . . . . . . d d d d d d d d d d d d d d d d d d d d d . d d
    . . . . . . . . d d d d d d d d d d d d d d d d d d d . . . d d
    . . . . . . . . d d d d d d d d d d d d d d d d d . . . . . . d
    . . . . . . . d d d d d d d d d d d d d d d d d 1 . . . . d d d
    . . . . . . d d d d d d d d d d d d d d d d d d 1 . . . . d d .
    . . . . d d d d d d d d d d d d d d d d d d d 1 d . . . . d . .
    . . d d d d d d d d d d d d d d d d d d d d d 1 d d d . . . . .
    . d d d d d d d d d d d d d d d d d d d d d d d d d d . . . . .
    d d d d d . . . . . d d d d d d d d d d 1 1 . d d d d d . . . .
    d d d d . . . . . d d d d d d d d 1 1 1 d d . . . d d d d . . .
    d d d . . . . . . d d d d d . . . d d d d d . . . d d d d . . .
    d d d . . . . . . d d d . . . . . . d d d d . . . . . d d d . .
    d d d . . . . . . d d d . . . . . . . d d d d . . . . d d d . .
    d d d . . . . . d d d . . . . . . . . . d d d . . . . d d d d .
    d d . . . . . . d d d . . . . . . . . . d d d . . . . . d d d .
    d d . . . . . . d d d . . . . . . . . . . d d d . . . . . d d d
    d d . . . . . . d d d . . . . . . . . d . . d d . . . . . . d d
    d d d . . . . . . d d . . . . . . . . d d d d d . . . . . . d d
    . d d . . . . . . . d d d . . . . . . . d d d . . . . . . d . .
`, SpriteKind.Enemy)
let shark = sprites.create(img`
    . . . . 8 d d .
    . . . 8 d d . .
    . . 8 d 1 . . .
    . 8 d d 1 . . .
    . 8 d d d 1 . .
    . d d d d d 1 .
    7 d d d d d d 7
    . 7 7 7 7 7 7 .
`, SpriteKind.Enemy)
let coin = sprites.create(img`
    . . 4 4 4 4 . .
    . 4 5 5 5 5 4 .
    4 5 5 4 5 5 5 4
    4 5 5 4 5 5 5 4
    4 5 5 4 5 5 5 4
    4 5 5 4 5 5 5 4
    . 4 5 5 5 5 4 .
    . . 4 4 4 4 . .
`, SpriteKind.Food)
controller.moveSprite(mySprite)
scene.cameraFollowSprite(mySprite)
tiles.setTilemap(tiles.createTilemap(
            hex`2000200001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010110010101010101010101010101010101010101010101010101110101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101011313010101010101010101010101010101010101010101010101010101010102030303030303030303030303030314010101010101010101010101010101010203030303030303030303030303031401010101010101010101010101010101020503040101010101010101010101010101010101010101010101010101010102030304011201010101010101010101010101010101010101010101010101010203050401010101010101010101010101010101010101010101010101010101020303040101010101010101010101010101010101010101010101010101010102050304010101010101010101010101010101010101010101010101010101010203030401010101010101010101010101010101010101010101010101010101020305040101010101010101010101010101010101010101010101010101010102030304010101010101010101010101010101010101010101010101010101010205030401010101010101010101010101010101010101010101010101010101020303040101010101010101010101010101010101010101010101010101010102030504010101010101010101010101010101010101010101010101010101010203030401010101010101010101010101010101010101010101010101010101020503040101010101010101010101010101010101010101010101010101010101131301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101`,
            img`
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
            `,
            [myTiles.tile0,myTiles.tile2,myTiles.tile3,myTiles.tile4,myTiles.tile5,myTiles.tile6,myTiles.tile7,myTiles.tile8,myTiles.tile9,myTiles.tile10,myTiles.tile11,myTiles.tile12,myTiles.tile13,myTiles.tile14,myTiles.tile15,myTiles.tile16,myTiles.tile17,myTiles.tile18,myTiles.tile19,myTiles.tile20,myTiles.tile21],
            TileScale.Eight
        ))
let coinTiles = tiles.getTilesByType(myTiles.tile6)
coinTiles.forEach(function (value: tiles.Location, index: number) {
    let newCoin = sprites.create(coin.image, SpriteKind.Food)
    tiles.placeOnTile(newCoin, value)
    tiles.setTileAt(value, myTiles.tile4);
})
let playerSpawnTile = tiles.getTilesByType(myTiles.tile17)[0]
mySprite.x = playerPosition.x = playerSpawnTile.x
mySprite.y = playerPosition.y = playerSpawnTile.y
tiles.setTileAt(playerSpawnTile, myTiles.tile2)

let octopusSpawnTile = tiles.getTilesByType(myTiles.tile18)[0]
octopus.x = octopusPosition.x = octopusSpawnTile.x
octopus.y = octopusPosition.y = octopusSpawnTile.y
tiles.setTileAt(octopusSpawnTile, myTiles.tile2)

let sharkSpawnTile = tiles.getTilesByType(myTiles.tile19)[0]
shark.x = sharkPosition.x = sharkSpawnTile.x
shark.y = sharkPosition.y = sharkSpawnTile.y
tiles.setTileAt(sharkSpawnTile, myTiles.tile2)

function positionToTile(position:number, tileSize:number):number {
    return Math.floor(position/tileSize);
}
function isWaterTile(tileImage:Image):boolean {
    if(tileImage == myTiles.tile2 || 
        tileImage == myTiles.tile3 ||
        tileImage == myTiles.tile5 ||
        tileImage == myTiles.tile7 ||
        tileImage == myTiles.tile8 ||
        tileImage == myTiles.tile9 ||
        tileImage == myTiles.tile10 ||
        tileImage == myTiles.tile11 ||
        tileImage == myTiles.tile12 ||
        tileImage == myTiles.tile13 ||
        tileImage == myTiles.tile14 ||
        tileImage == myTiles.tile15 ||
        tileImage == myTiles.tile16){
        return true
    }
    return false
}

function isLandTile(tileImage:Image):boolean{
    if(tileImage == myTiles.tile4){
        return true
    }
    return false
}

function checkLandBoundsCollision(character:Sprite, lastPosition:Point):Point{
    let newTile: Image = tiles.getTileAt(positionToTile(character.x, tileSize), positionToTile(character.y, tileSize))
    if (lastPosition.tile == null) {
        lastPosition.tile = newTile
    }

    if (isLandTile(newTile) && isWaterTile(lastPosition.tile) || 
        isWaterTile(newTile) && isLandTile(lastPosition.tile)) {
            //todo: determine whether it's a horizontal or vertical collision and limit movement
            //also need to check whether the other position change results in a tile collision, like in a corner
        character.x = lastPosition.x
        character.y = lastPosition.y
        return lastPosition;
    }
    lastPosition.x = character.x
    lastPosition.y = character.y
    lastPosition.tile = newTile
    return lastPosition
}

function findOctopusMovePosition(octopusPosition: Point, playerPosition: Point, buffer:number): Point {
    let moveLeft: boolean = playerPosition.x < octopusPosition.x - buffer
    let moveRight: boolean = playerPosition.x > octopusPosition.x + buffer
    let moveUp: boolean = playerPosition.y < octopusPosition.y - buffer
    let moveDown: boolean = playerPosition.y > octopusPosition.y + buffer
    let moveRate: number = .4

    if (moveLeft) {
        octopusPosition.x -= moveRate
    } else if (moveRight) {
        octopusPosition.x += moveRate
    }
    if (moveUp) {
        octopusPosition.y -= moveRate
    } else if (moveDown) {
        octopusPosition.y += moveRate
    }
    return octopusPosition
}

function seekPath(startingTile: GridSpot, targetTile: GridSpot, currentPath: Array<GridSpot>, closedTiles: Array<GridSpot>): Array<GridSpot>{
    
    return currentPath
}

function findSharkMovePosition(sharkPosition: Point, seekPath:Array<GridSpot>):Point{

    //need to keep track of tile position of player and only recalculate if the player has changed tiles

    return sharkPosition
}

function findSharkTargetTile(playerPosition:Point):GridSpot {
    let resultGridSpot = new GridSpot()
    if(isWaterTile(playerPosition.tile)){
        resultGridSpot.row = positionToTile(playerPosition.y, tileSize)
        resultGridSpot.column = positionToTile(playerPosition.x, tileSize)
        return resultGridSpot
    }

    return resultGridSpot
}

function moveGameSprite(position:Point, sprite:Sprite):void {
    sprite.x = Math.floor(position.x)
    sprite.y = Math.floor(position.y)
}

game.onUpdate(function () {
    playerPosition = checkLandBoundsCollision(mySprite, playerPosition)
    //move octopus 
    octopusPosition = findOctopusMovePosition(octopusPosition, playerPosition, hitBuffer)
    moveGameSprite(octopusPosition, octopus)
    //move shark 
    let targetTile = findSharkTargetTile(playerPosition)
    if(targetTile.column > 0 && targetTile.row > 0){ //temporary check to make sure that shark has found a tile
        if(sharkSeekPath.length === 0 || !targetTile.equals(sharkSeekPath[sharkSeekPath.length - 1])){
            //sharkSeekPath = seekPath(sharkPosition, (startingTile), [], [])
        }
    }
    //check for shark/octopus collision with some buffer
})

//add crate unlock for final item

