namespace myTiles {
    //% blockIdentity=images._tile
    export const tile0 = img`
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
        . . . . . . . . . . . . . . . .
    `
    //% blockIdentity=images._tile
    export const tile2 = img`
        b b b b b b b b
        e e e b b b b b
        b b b b b b b b
        b b b b b e e e
        b b b b b b b b
        b b e e e e e b
        b b b b b b b b
        b e e b b b e b
    `
    //% blockIdentity=images._tile
    export const tile3 = img`
        b b b b b b e d
        b b b e e b e d
        b b b b b b e d
        e e b b b b e d
        b b b b b b e d
        b b b b b b e d
        b b e e b b e d
        b b b b b b e d
    `
    //% blockIdentity=images._tile
    export const tile4 = img`
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
        7 7 7 7 7 7 7 7
    `
    //% blockIdentity=images._tile
    export const tile5 = img`
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
    `
    //% blockIdentity=images._tile
    export const tile6 = img`
        7 5 5 5 5 5 5 7
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        5 7 7 7 7 7 7 5
        7 5 5 5 5 5 5 7
    `
    //% blockIdentity=images._tile
    export const tile7 = img`
        b b b b b b b b
        e e e e e e e e
        d d d d d d d d
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile8 = img`
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        d d d d d d d d
        e e e e e e e e
        b b b b b b b b
    `
    //% blockIdentity=images._tile
    export const tile9 = img`
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d d d d d d
        b e e e e e e e
        b b b b b b b b
    `
    //% blockIdentity=images._tile
    export const tile10 = img`
        b b b b b b b b
        e e e e e e e b
        d d d d d d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
    `
    //% blockIdentity=images._tile
    export const tile11 = img`
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        8 8 8 8 8 d e b
        d d d d d d e b
        e e e e e e e b
        b b b b b b b b
    `
    //% blockIdentity=images._tile
    export const tile12 = img`
        b b b b b b b b
        b e e e e e e e
        b e d d d d d d
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
        b e d 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile13 = img`
        8 8 8 8 8 d e b
        8 8 8 8 8 d e e
        8 8 8 8 8 d d d
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile14 = img`
        b e d 8 8 8 8 8
        e e d 8 8 8 8 8
        d d d 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile15 = img`
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        d d d 8 8 8 8 8
        e e d 8 8 8 8 8
        b e d 8 8 8 8 8
    `
    //% blockIdentity=images._tile
    export const tile16 = img`
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 8 8 8
        8 8 8 8 8 d d d
        8 8 8 8 8 d e e
        8 8 8 8 8 d e b
    `
    //% blockIdentity=images._tile
    export const tile17 = img`
        b b b b b b b b
        b b 3 3 3 b b b
        b b 3 b b 3 b b
        b b 3 b b 3 b b
        b b 3 3 3 b b b
        b b 3 b b b b b
        b b 3 b b b b b
        b b b b b b b b
    `
    //% blockIdentity=images._tile
    export const tile18 = img`
        d b b b b b b d
        b d b b b b d b
        b b d b b d b b
        b b b d d b b b
        b b b d d b b b
        b b d b b d b b
        b d b b b b d b
        d b b b b b b d
    `
    //% blockIdentity=images._tile
    export const tile19 = img`
        b b b b b b b b
        b b 2 2 2 b b b
        b 2 b b b 2 b b
        b 2 b b b b b b
        b b 2 2 2 b b b
        b b b b b 2 b b
        b 2 b b b 2 b b
        b b 2 2 2 b b b
    `
    //% blockIdentity=images._tile
    export const tile20 = img`
        4 4 4 4 4 4 4 4
        4 4 4 4 4 4 4 4
        5 5 5 5 5 5 5 5
        4 4 4 4 4 4 4 4
        4 4 4 4 4 4 4 4
        5 5 5 5 5 5 5 5
        4 4 4 4 4 4 4 4
        4 4 4 4 4 4 4 4
    `
    //% blockIdentity=images._tile
    export const tile21 = img`
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
        4 4 5 4 4 5 4 4
    `
    //% blockIdentity=images._tile
    export const tile22 = img`
        b b b 5 5 b b b
        b 5 b 5 5 b 5 b
        b b b 5 b b b b
        5 5 b b b 5 5 5
        5 5 5 b b b 5 5
        b b b b 5 b b b
        b 5 b 5 5 b 5 b
        b b b 5 5 b b b
    `
    //% blockIdentity=images._tile
    export const tile23 = img`
        d d d d d d d d
        d 4 5 4 4 5 4 d
        d 4 5 4 4 5 4 d
        d d d d d d d d
        d 4 5 d d 5 4 d
        d 4 5 4 4 5 4 d
        d 4 5 4 4 5 4 d
        d d d d d d d d
    `
    //% blockIdentity=images._tile
    export const tile24 = img`
        d d d d d d d d
        d d d d d d d d
        d d d d d d d d
        d d d d d d d d
        d 4 5 d d 5 4 d
        d 4 5 4 4 5 4 d
        d 4 5 4 4 5 4 d
        d d d d d d d d
    `
}
let waypointHolding:HelperClasses.Waypoint = null
let sharkFollowsPlayer = false
let sharkTargetWaypoint: HelperClasses.Waypoint = null
let sharkPreviousWaypoint: HelperClasses.Waypoint = null
let playerInWater:boolean = false
let sharkSeekPath: Array<HelperClasses.PathPosition> = []
let waypoints: Array<HelperClasses.Waypoint> = []
let totalGuffins = 0
let currentLevel = 0
let finalTargetTiles: tiles.Location[] = []
const HIT_BUFFER:number = 4
const TILE_SIZE:number = 8
const PLAYER_MOVE_SPEED:number = 100
const SHARK_MOVE_SPEED:number = 2.1
let playerPosition: HelperClasses.Point = new HelperClasses.Point(0, 0)
let octopusPosition: HelperClasses.Point = new HelperClasses.Point(0, 0)
let sharkPosition: HelperClasses.Point = new HelperClasses.Point(0, 0)
let mySprite = sprites.create(img`
    . . . . . . . .
    . . . 1 1 . . .
    . . 1 1 1 1 . .
    3 4 1 1 1 1 4 3
    3 4 4 1 1 4 4 3
    . . 4 1 1 4 . .
    . . 1 1 1 1 . .
    . . . . . . . .
`, SpriteKind.Player)
let octopus = sprites.create(img`
    . a d d d . . . . . . . a d d d d d . . . . . . . . a a d d . .
    a d d . . . . . . . . a d d d d d d d d . . . . . a d d d d d .
    a d . . . . . . . . a d d 1 . . . . . d d . . . . a d . . . d d
    a d . . . . . . . . a d 1 . . . . . . . . . . . a d 1 . . . d d
    a d . . . . . . . . a d 1 . . . . . . . . . . a d d 1 . . . . d
    a d 1 . . . . . . . a d d d . . . . . . . . a d d d 1 . . . . .
    a d d 1 . . . . . . a d d a a a a a d d . . a d d d . . . . . .
    . a d d 1 . . . . . . a a d d d d d d d d d d d 1 . . . . . . .
    . . a d d d d d d . a d d d d d a d d d d d d d 1 . . . . . . .
    . . . a a d d d d a d d d a d d d d d d a d d d . . . . . . . .
    . . . . . a d d d a d d d d d d d d d d d d d d . . . . . a d .
    . . . . . . a a a d d d d d d d d a d d d d d d d . a a a d d d
    . . . . . . . . a d d a d d d d d d d d d d a d d a d d d d d d
    . . . . . . . . d d d d d d d d d d d d d d d d d d d 1 1 . d d
    . . . . . . . . d d d d d d d 1 1 1 d d d d d d d d d . . . d d
    . . . . . . . . d d d d d d 1 a a a 1 d d d d d d . . . . . . d
    . . . . . . . a d d d d d d 1 a d a 1 d d d d d 1 . . . . d d d
    . . . . . . a d d d d d d d 1 a d a 1 d d d d d 1 . . . . d d .
    . . . . a a d d d d d d d d 1 a a a 1 d d d d 1 d . . . . d . .
    . . a a d d d d d d d d d d d 1 1 1 d d d d d 1 d d 1 . . . . .
    . a d d d d d 1 1 1 d d d d d d d d d d d d d d d d 1 . . . . .
    a d d d d . . . . . a a d d d d d d d d 1 1 . d d d d 1 . . . .
    a d d d . . . . . a d d d d d d d 1 1 1 d 1 . . . d d d 1 . . .
    a d d . . . . . . a d d d d . . . d d d d 1 . . . a d d 1 . . .
    a d d . . . . . . a d d . . . . . . a d d 1 . . . . . d d 1 . .
    a d d . . . . . . a d d . . . . . . . a d d 1 . . . . d d 1 . .
    a d d . . . . . a d d . . . . . . . . . a d 1 . . . . a d d 1 .
    d d . . . . . . a d d . . . . . . . . . a d d . . . . . d d d .
    d d . . . . . . a d d . . . . . . . . . . d d d . . . . . d d d
    d d . . . . . . a d d . . . . . . . . d . . d d . . . . . . a d
    d d d . . . . . . a d . . . . . . . . d d d d d . . . . . . d d
    . d d . . . . . . . d d d . . . . . . . d d d . . . . . . d . .
`, SpriteKind.Enemy)
let shark = sprites.create(img`
    . . . . 8 d d .
    . . . 8 d d . .
    . . 8 d 1 . . .
    . 8 d d 1 . . .
    . 8 d d d 1 . .
    . d d d d d 1 .
    7 d d d d d d 7
    . 7 7 7 7 7 7 .
`, SpriteKind.Enemy)
let coin = sprites.create(img`
    . . 4 4 4 4 . .
    . 4 5 5 5 5 4 .
    4 5 5 4 5 5 5 4
    4 5 5 4 5 5 5 4
    4 5 5 4 5 5 5 4
    4 5 5 4 5 5 5 4
    . 4 5 5 5 5 4 .
    . . 4 4 4 4 . .
`, SpriteKind.Food)
let sharkTargetTile = new HelperClasses.Point()
const STATE_LEVEL_INIT: string = "state_level_init"
const STATE_LEVEL_PLAY: string = "state_level_play"
const STATE_LEVEL_END: string = "state_level_end"
const STATE_LEVEL_INTRO: string = "state_level_intro"
const STATE_GAME_OVER: string = "state_game_over"
let gameState:StateMachine.StateMachine = new StateMachine.StateMachine()

let levels = [
    tiles.createTilemap(
        hex`2000200001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010110010101010101010101010101010101010101010101010101110101010101010101010101010101010101010101010101010101010101010101010101010101010115010101010101010101010101010101010101150101010101010101010101010101011313010101010101010101010101010101010101010101010101010101010102030303030303030303030303030314010101010101010101010101010101010203030303030303030303030303031401010101010101010101010101010101020503040101010101010101010101010101010101010101010101010101120102030304011501010101010101010101011501010101010101010101010101010203050401010101010101010101010101010101010101010101010101010101020303040101010101010101010101010101010101010101010101010101010102050304010101010101010101010101010101010101010101010101010101010203030401010101010101010101010101010101010101010101010101010101020305040101010101010101010101010101010101010101010101010101010102030304010101010101010101010101010101010101010101010101010101010205030401010101010101150101010101150101010101011501010101010101020303040101010101010101010101010101010101010101010101010101010102030504010101010101010101010101010101010101010101010101010101010203030401010101010101010101010101010101010101010101010101010101020503040101010101010101010101010101010101010101010101010101010101131301010101010101010101010101010101131313010101010101010115010101010101150101010101150101010101010303030303010101010101010101010101010101010101010101010101010114030303030301010101010101010101010101010101010101010101010101011403031603030101010101010101010101010101010101010101010101010101140303030303010101010101010101010101010101010101010101010101010101030303030301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101011501010101010115010101010115010101010101010101010101150101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101`,
        img`
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
                . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
            `,
        [myTiles.tile0, myTiles.tile2, myTiles.tile3, myTiles.tile4, myTiles.tile5, myTiles.tile6, myTiles.tile7, myTiles.tile8, myTiles.tile9, myTiles.tile10, myTiles.tile11, myTiles.tile12, myTiles.tile13, myTiles.tile14, myTiles.tile15, myTiles.tile16, myTiles.tile17, myTiles.tile18, myTiles.tile19, myTiles.tile20, myTiles.tile21, myTiles.tile22, myTiles.tile23, myTiles.tile24],
        TileScale.Eight
    )
]
function positionToTile(position: number, tileSize: number): number {
    return Math.floor(position / tileSize);
}
function isWaterTile(tileImage: Image): boolean {
    if (tileImage == myTiles.tile2 ||
        tileImage == myTiles.tile3 ||
        tileImage == myTiles.tile5 ||
        tileImage == myTiles.tile7 ||
        tileImage == myTiles.tile8 ||
        tileImage == myTiles.tile9 ||
        tileImage == myTiles.tile10 ||
        tileImage == myTiles.tile11 ||
        tileImage == myTiles.tile12 ||
        tileImage == myTiles.tile13 ||
        tileImage == myTiles.tile14 ||
        tileImage == myTiles.tile15 ||
        tileImage == myTiles.tile16) {
        return true
    }
    return false
}
function isLandTile(tileImage: Image): boolean {
    if (tileImage == myTiles.tile4) {
        return true
    }
    return false
}
function isWinningTile(tileImage: Image): boolean {
    if (tileImage == myTiles.tile24) {
        return true
    }
    return false
}
function checkLandBoundsCollision(character: Sprite, lastPosition: HelperClasses.Point): HelperClasses.Point {
    let newTile: Image = tiles.getTileAt(positionToTile(character.x, TILE_SIZE), positionToTile(character.y, TILE_SIZE))
    if (lastPosition.tile == null) {
        lastPosition.tile = newTile
    }

    if (isLandTile(newTile) && isWaterTile(lastPosition.tile) ||
        isWaterTile(newTile) && isLandTile(lastPosition.tile)) {
        //todo: determine whether it's a horizontal or vertical collision and limit movement
        //also need to check whether the other position change results in a tile collision, like in a corner
        character.x = lastPosition.x
        character.y = lastPosition.y
        return lastPosition;
    }
    lastPosition.x = character.x
    lastPosition.y = character.y
    lastPosition.tile = newTile
    return lastPosition
}
function findOctopusMovePosition(octopusPosition: HelperClasses.Point, playerPosition: HelperClasses.Point, buffer: number): HelperClasses.Point {
    let moveLeft: boolean = playerPosition.x < octopusPosition.x - buffer
    let moveRight: boolean = playerPosition.x > octopusPosition.x + buffer
    let moveUp: boolean = playerPosition.y < octopusPosition.y - buffer
    let moveDown: boolean = playerPosition.y > octopusPosition.y + buffer
    let moveRate: number = .4

    if (moveLeft) {
        octopusPosition.x -= moveRate
    } else if (moveRight) {
        octopusPosition.x += moveRate
    }
    if (moveUp) {
        octopusPosition.y -= moveRate
    } else if (moveDown) {
        octopusPosition.y += moveRate
    }
    return octopusPosition
}
function findSharkMovePosition(sharkPosition: HelperClasses.Point, seekPath: Array<HelperClasses.PathPosition>): HelperClasses.Point {

    //need to keep track of tile position of player and only recalculate if the player has changed tiles

    return sharkPosition
}
function findSharkTargetTile(playerPosition: HelperClasses.Point): HelperClasses.Point {
    let resultGridSpot = new HelperClasses.Point()
    if (isWaterTile(playerPosition.tile)) {
        resultGridSpot.y = playerPosition.y
        resultGridSpot.x = playerPosition.x
        return resultGridSpot
    }
    //todo: implement roaming

    return resultGridSpot
}
function moveGameSprite(position: HelperClasses.Point, sprite: Sprite): void {
    sprite.x = Math.floor(position.x)
    sprite.y = Math.floor(position.y)
}
function moveTowardPoint(position: HelperClasses.Point, point: HelperClasses.Point, moveRate:number):HelperClasses.Point{
    if(position.x < point.x){
        position.x += moveRate
        if(position.x > point.x){
            position.remainder = position.x - point.x
            position.x = point.x
        }
    }
    if(position.x > point.x){
        position.x -= moveRate
        if (position.x < point.x) {
            position.remainder = point.x - position.x
            position.x = point.x
        }
    }
    if(position.y < point.y){
        position.y += moveRate
        if (position.y > point.y) {
            position.remainder = position.y - point.y
            position.y = point.y
        }
    }
    if (position.y > point.y) {
        position.y -= moveRate
        if (position.y < point.y) {
            position.remainder = point.y - position.y
            position.y = point.y
        }
    }
    return position
}
sprites.onOverlap(SpriteKind.Player, SpriteKind.Food, function (sprite, otherSprite) {
    info.setScore(info.score() + 1)
    otherSprite.destroy()
    if (info.score() > totalGuffins) {
        finalTargetTiles = tiles.getTilesByType(myTiles.tile23)
        finalTargetTiles.forEach(function (value: tiles.Location, index: number) {
            tiles.setTileAt(value, myTiles.tile24)
        })
    }
})
gameState.addBeforeStateChange(function (newState: string, oldState: string) {
    switch (oldState) {
        case STATE_LEVEL_INTRO:

            break;

        case STATE_LEVEL_INIT:

            break;

        case STATE_LEVEL_PLAY:
            controller.moveSprite(mySprite, 0, 0)
            break;

        case STATE_LEVEL_END:

            break;
    }
})
gameState.addStateChange(function (currentState: string) {
    switch (currentState) {
        case STATE_LEVEL_INTRO:

            break;

        case STATE_LEVEL_INIT:
            tiles.setTilemap(levels[currentLevel])
            break;

        case STATE_LEVEL_PLAY:
            controller.moveSprite(mySprite, PLAYER_MOVE_SPEED, PLAYER_MOVE_SPEED)
            scene.cameraFollowSprite(mySprite)
            break;

        case STATE_LEVEL_END:

            break;
    }
})
game.onUpdate(function () {
    switch(gameState.getState()){
        case STATE_LEVEL_INTRO:

        break;

        case STATE_LEVEL_INIT:
            let coinTiles = tiles.getTilesByType(myTiles.tile6)
            coinTiles.forEach(function (value: tiles.Location, index: number) {
                let newCoin = sprites.create(coin.image, SpriteKind.Food)
                tiles.placeOnTile(newCoin, value)
                tiles.setTileAt(value, myTiles.tile4);
                totalGuffins++
            })
            let waypointTiles = tiles.getTilesByType(myTiles.tile22)
            waypointTiles.forEach(function (value: tiles.Location, index: number) {
                tiles.setTileAt(value, myTiles.tile2)
                waypoints.push(new HelperClasses.Waypoint(new HelperClasses.Point(value.x, value.y)))
            })
            waypoints = Pathfinding.connectWaypoints(waypoints)
            let playerSpawnTile = tiles.getTilesByType(myTiles.tile17)[0]
            mySprite.x = playerPosition.x = playerSpawnTile.x
            mySprite.y = playerPosition.y = playerSpawnTile.y
            tiles.setTileAt(playerSpawnTile, myTiles.tile2)
            let octopusSpawnTile = tiles.getTilesByType(myTiles.tile18)[0]
            octopus.x = octopusPosition.x = octopusSpawnTile.x
            octopus.y = octopusPosition.y = octopusSpawnTile.y
            tiles.setTileAt(octopusSpawnTile, myTiles.tile2)
            let sharkSpawnTile = tiles.getTilesByType(myTiles.tile19)[0]
            shark.x = sharkPosition.x = sharkSpawnTile.x
            shark.y = sharkPosition.y = sharkSpawnTile.y
            tiles.setTileAt(sharkSpawnTile, myTiles.tile2)
            gameState.changeState(STATE_LEVEL_PLAY)
        break;

        case STATE_LEVEL_PLAY:
            playerPosition = checkLandBoundsCollision(mySprite, playerPosition)
            playerInWater = isWaterTile(playerPosition.tile)
            // move octopus
            octopusPosition = findOctopusMovePosition(octopusPosition, playerPosition, HIT_BUFFER)
            moveGameSprite(octopusPosition, octopus)
            // move shark
            sharkFollowsPlayer = false
            if (playerInWater && sharkPosition.calculateDistance(playerPosition) <= TILE_SIZE * 10) {
                sharkTargetTile = findSharkTargetTile(playerPosition)
                sharkSeekPath = Pathfinding.seekPath(sharkPosition, playerPosition, 10)
                sharkFollowsPlayer = sharkSeekPath.length > 1
            }
            if (sharkFollowsPlayer) {
                sharkTargetWaypoint = null
                moveTowardPoint(sharkPosition, sharkSeekPath[1].point, SHARK_MOVE_SPEED)
                if (sharkPosition.equals(sharkSeekPath[1].point)) {
                    if (sharkPosition.remainder > 0 && sharkSeekPath.length > 2) {
                        moveTowardPoint(sharkPosition, sharkSeekPath[2].point, sharkPosition.remainder)
                    }
                }
            } else {
                if (sharkTargetWaypoint == null) {
                    sharkTargetWaypoint = Pathfinding.getClosestWaypoint(sharkPosition, waypoints)
                }
                moveTowardPoint(sharkPosition, sharkTargetWaypoint.point, SHARK_MOVE_SPEED)
                if (sharkPosition.equals(sharkTargetWaypoint.point)) {
                    waypointHolding = sharkTargetWaypoint
                    if (playerInWater) {
                        sharkTargetWaypoint = sharkTargetWaypoint.getClosestConnectionToPoint(playerPosition)
                    } else {
                        sharkTargetWaypoint = sharkTargetWaypoint.getRandomConnection(sharkPreviousWaypoint === null ? [] : [sharkPreviousWaypoint])
                    }
                    if (sharkPosition.remainder > 0) {
                        moveTowardPoint(sharkPosition, sharkTargetWaypoint.point, sharkPosition.remainder)
                    }
                    sharkPreviousWaypoint = waypointHolding
                }
            }
            moveGameSprite(sharkPosition, shark)
            sharkPosition.remainder = 0
            if (isWinningTile(playerPosition.tile)) {
                currentLevel++
                gameState.changeState(STATE_LEVEL_END)
            }
        break;

        case STATE_LEVEL_END:

        break;
    }
})


gameState.changeState(STATE_LEVEL_INIT);
